<!DOCTYPE html>
<html lang="ru">
<meta charset="utf-8">
<title>–í—Ö–æ–¥ –ø–æ Email (Magic Link)</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { font:16px/1.3 system-ui,sans-serif; max-width:420px; margin:4rem auto; text-align:center; }
  input, button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:1px solid #ccc; }
  button { cursor:pointer; }
  .ok { color:#0a7a30 }
  .err { color:#b00020 }
  #status { margin-top:20px; }
</style>

<body>
  <h1>–í—Ö–æ–¥ –ø–æ Email</h1>

  <div id="loginForm">
    <input id="email" type="email" placeholder="you@example.com" required>
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
    <p id="msg"></p>
  </div>

  <div id="waiting" style="display:none;">
    <p>üì© –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É...</p>
    <p id="status">‚è≥ –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...</p>
  </div>

<script>
const SUPABASE_URL = "https://gilbbgbmzzxsfnuguzci.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbGJiZ2Jtenp4c2ZudWd1emNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNzgyNTMsImV4cCI6MjA3Mjc1NDI1M30.ZlVU1kGvphzdEKAhVnMHnKQxcfhVcTpvYIFMhbrWURA"; // –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–ª—é—á
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);

// –û—Ç–ø—Ä–∞–≤–∫–∞ –º–∞–≥–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
$('send').onclick = async () => {
  const email = $('email').value.trim();
  if (!email) return $('msg').textContent = '–í–≤–µ–¥–∏—Ç–µ e-mail';

  $('msg').textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É...';
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.href }
  });

  if (error) {
    $('msg').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
    $('msg').className = 'err';
  } else {
    $('loginForm').style.display = 'none';
    $('waiting').style.display = 'block';
  }
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞–≥–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
async function handleMagicLink() {
  const { data, error } = await supabase.auth.getSessionFromUrl({ storeSession: true });
  if (error) return $('status').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;

  if (data.session) {
    $('loginForm').style.display = 'none';
    $('waiting').style.display = 'block';
    checkEmailConfirmed();
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email
async function checkEmailConfirmed() {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error) return $('status').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;

  if (user?.email_confirmed_at) {
    $('status').textContent = '‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...';
    $('status').className = 'ok';
    setTimeout(() => window.location.href = '/success.html', 1000);
  } else {
    $('status').textContent = '‚è≥ –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...';
    $('status').className = 'err';
    setTimeout(checkEmailConfirmed, 3000); // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
  }
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', handleMagicLink);

// –†–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
supabase.auth.onAuthStateChange(() => checkEmailConfirmed());
</script>
</body>
</html>
