<!DOCTYPE html>
<html lang="ru">
<meta charset="utf-8">
<title>–í—Ö–æ–¥ –ø–æ Email (Magic Link)</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body { font:16px/1.3 system-ui,sans-serif; max-width:420px; margin:4rem auto; text-align:center; }
  input, button { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:1px solid #ccc; }
  button { cursor:pointer; }
  .ok { color:#0a7a30 }
  .err { color:#b00020 }
  #status { margin-top:20px; }
</style>

<body>
  <h1>–í—Ö–æ–¥ –ø–æ Email</h1>

  <div id="loginForm">
    <input id="email" type="email" placeholder="you@example.com" required>
    <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
    <p id="msg"></p>
  </div>

  <div id="waiting" style="display:none;">
    <p>üì© –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ—á—Ç—É...</p>
    <p id="status">‚è≥ –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...</p>
  </div>

<script>
const SUPABASE_URL = "https://gilbbgbmzzxsfnuguzci.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbGJiZ2Jtenp4c2ZudWd1emNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNzgyNTMsImV4cCI6MjA3Mjc1NDI1M30.ZlVU1kGvphzdEKAhVnMHnKQxcfhVcTpvYIFMhbrWURA";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);

// –û—Ç–ø—Ä–∞–≤–∫–∞ –º–∞–≥–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
$('send').onclick = async () => {
  const email = $('email').value.trim();
  if (!email) return $('msg').textContent = '–í–≤–µ–¥–∏—Ç–µ e-mail';

  $('msg').textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É...';

  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.href } // —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å—é–¥–∞
  });

  if (error) {
    $('msg').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
    $('msg').className = 'err';
  } else {
    $('loginForm').style.display = 'none';
    $('waiting').style.display = 'block';
  }
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ email
async function checkEmailConfirmed() {
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error) {
    $('status').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
    $('status').className = 'err';
    return false;
  }
  return user?.email_confirmed_at ? true : false;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –∏ email
async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    const confirmed = await checkEmailConfirmed();
    if (confirmed) {
      $('status').textContent = '‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...';
      $('status').className = 'ok';
      setTimeout(() => {
        window.location.href = '/success.html';
      }, 1000);
    } else {
      $('status').textContent = '‚ö† Email –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.';
      $('status').className = 'err';
    }
  }
}

// –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ —Å—Å—ã–ª–∫–µ)
window.addEventListener('load', checkSession);

// –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
supabase.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && session) {
    const confirmed = await checkEmailConfirmed();
    if (confirmed) {
      $('status').textContent = '‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...';
      $('status').className = 'ok';
      setTimeout(() => {
        window.location.href = '/success.html';
      }, 1000);
    } else {
      $('status').textContent = '‚ö† Email –µ—â—ë –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.';
      $('status').className = 'err';
    }
  }
});

// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
setInterval(checkSession, 3000);
</script>
</body>
</html>


